<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FUJINZU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { margin: 0; }
    #map { width: 100vw; height: 100vh; }
  </style>
</head>
<body>

  <!--Slider-->
  <div id="slider-container">
    <label for="yearSlider">年:</label>
    <input type="range" id="yearSlider" min="1400" max="1900" step="10" value="1600">
    <span id="yearValue">1600</span>
  </div>
  
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- PapaParse (CSVパーサー) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    const markers = [];
    // 地図を表示（初期位置：埼玉の真ん中あたり）
    const map = L.map('map').setView([36.035420, 139.410082], 10);

    // OpenStreetMapのタイルを表示
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    //県境表示
    fetch('https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson')
      .then(res => res.json())
      .then(data => {
        const saitama = data.features.find(f => f.properties.id === 11);
        L.geoJSON(saitama, {
          style: {
            color: 'blue',
            weight: 1,
            fillOpacity: 0
          }
        }).addTo(map);
    });

    // スライダー制御
    const slider = document.getElementById('yearSlider');
    const yearValue = document.getElementById('yearValue');

    function updateMarkerColors(year) {
      markers.forEach(marker => {
        const isChikujo = marker.chikujo < year;
        const isHaijo = marker.haijo < year;
        marker.setStyle({
          fillColor: isHaijo ? "gray" : isChikujo ? "blue" : "white"
        });
      });
    }
    
    slider.addEventListener('input', () => {
      const year = parseInt(slider.value, 10);
      yearValue.textContent = year;
      updateMarkerColors(year);
    });
    
    // CSV読み込みとマーカー表示
    Papa.parse('saitama_castles.csv', {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          const lat = parseFloat(row.緯度);
          const lng = parseFloat(row.経度);
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.circleMarker([lat, lng], {
              radius: 8,
              fillColor: "blue",
              color: "black",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).bindPopup(`<strong>${row.城址名}</strong>`).addTo(map);
            console.log(`確認: ${row.城址名}`);
            marker.on('click', () => {
              console.log(`クリック: ${row.城址名}`);
            });
            marker.chikujo = parseInt(row.築城年, 10);
            marker.haijo = parseInt(row.廃城年, 10);
            markers.push(marker);
          }
        });

        //初期表示
        updateMarkerColors(parseInt(slider.value, 10));
      }
    });
    
  </script>

</body>
</html>
