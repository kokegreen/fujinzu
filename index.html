<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FUJINZU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { margin: 0; }
    #map { width: 100vw; height: 100vh; }
    #slider-container {
      position: absolute;
      top: 10px;
      left: 20px;
      background: white;
      padding: 5px;
      z-index: 1000;
    }
    #slider-container-kyoutoku {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <!--Slider-->
  <div id="slider-container">
    <label for="yearSlider">年:</label>
    <input type="range" id="yearSlider" min="1400" max="1900" step="10" value="1600">
    <span id="yearValue">1600</span>
  </div>
  <!--享徳用スライダー-->
  <div id="slider-container-kyoutoku">
    <label for="yearMonthSlider">年月:</label>
    <input type="range" id="yearSliderKyoutoku" min="0" max="1199" value="240">
    <span id="yearValueKyoutoku">1620-01</span>
  </div>
  
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- PapaParse (CSVパーサー) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    const markers = [];
    const markers_kyoutoku = [];
    // ベースレイヤー定義
    const baseLayers = {
      "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }),
      "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: 'Map data: &copy; OpenTopoMap contributors'
      }),
      "国土地理院 標準地図": L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '地図: 国土地理院'
      }),
      "国土地理院 色別標高図": L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', {
        maxZoom: 15,
        attribution: '地図: 国土地理院'
      })
    };
    // 地図初期化（OpenStreetMap を最初に表示）
    const map = L.map('map', {
      center: [36.035420, 139.410082],
      zoom: 10,
      layers: [baseLayers["OpenStreetMap"]]
    })
    // 地図を表示（初期位置：埼玉の真ん中あたり）  
      .setView([36.035420, 139.410082], 10);

    // レイヤーコントロールを追加
    L.control.layers(baseLayers).addTo(map);
    
    // OpenStreetMapのタイルを表示
    //L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //  maxZoom: 19,
    //  attribution: '&copy; OpenStreetMap contributors'
    //}).addTo(map);

    //県境表示
    //fetch('https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson')
    //  .then(res => res.json())
    //  .then(data => {
    //    const saitama = data.features.find(f => f.properties.id === 11);
    //    L.geoJSON(saitama, {
    //      style: {
    //        color: 'blue',
    //        weight: 1,
    //        fillOpacity: 0
    //      }
    //    }).addTo(map);
    //});

    // スライダー制御
    const slider = document.getElementById('yearSlider');
    const yearValue = document.getElementById('yearValue');
    const sliderKyoutoku = document.getElementById('yearSliderKyoutoku');
    const yearValueKyoutoku = document.getElementById('yearValueKyoutoku');
    const minYear = 1400;
    const maxMonthOffset = parseInt(sliderKyoutoku.max); // 1199 → 100年分

    function updateMarkerColors(year) {
      markers.forEach(marker => {
        const isChikujo = marker.chikujo < year;
        const isHaijo = marker.haijo < year;
        marker.setStyle({
          fillColor: isHaijo ? "gray" : isChikujo ? "blue" : "white",
          fillOpacity: isHaijo ? 0.5 : isChikujo ? 0.8 : 0.5,
          opacity: isHaijo ? 0.5 : isChikujo ? 1 : 0.5
        });
      });
    }
    function updateMarkerColorsKyoutoku(date) {
      markers_kyoutoku.forEach(marker => {
        const isThisMonth = ((date.getFullYear() == marker.hasseiDate.getFullYear()) && (date.getMonth() == marker.hasseiDate.getMonth()));
        const isFinished = marker.hasseiDate < date;
        console.log(marker.hasseiDate);
        marker.setStyle({
          fillColor: isFinished ? "red" : isThisMonth ? "red" : "white",
          fillOpacity: isFinished ? 0.5 : isThisMonth ? 0.8 : 0.3,
          opacity: isFinished ? 0.5 : isThisMonth ? 1 : 0.3
        });
      });
    }

    function updateKyoutokuDisplay(monthOffset) {
      const year = minYear + Math.floor(monthOffset / 12);
      const month = (monthOffset % 12) + 1;
      const formatted = `${year}-${month.toString().padStart(2, '0')}`;
      yearValueKyoutoku.textContent = formatted;
      return new Date(`${formatted}-01`);
    }
    
    slider.addEventListener('input', () => {
      const year = parseInt(slider.value, 10);
      yearValue.textContent = year;
      updateMarkerColors(year);
    });

    sliderKyoutoku.addEventListener('input', () => {
      const date = updateKyoutokuDisplay(parseInt(sliderKyoutoku.value, 10));
      //const year = parseInt(sliderKyoutoku.value, 10);
      //yearValueKyoutoku.textContent = year;
      updateMarkerColorsKyoutoku(date);
    });
    
    // 城址CSV読み込みとマーカー表示
    Papa.parse('saitama_castles.csv', {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          const lat = parseFloat(row.緯度);
          const lng = parseFloat(row.経度);
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.circleMarker([lat, lng], {
              radius: 8,
              fillColor: "blue",
              color: "black",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);
            marker.bindPopup(`<strong>${row.城址名}</strong>`);
            marker.chikujo = parseInt(row.築城年, 10);
            marker.haijo = parseInt(row.廃城年, 10);
            markers.push(marker);
          }
        });

        //初期表示
        updateMarkerColors(parseInt(slider.value, 10));
      }
    });

    // 享徳の乱CSV読み込みとマーカー表示
    Papa.parse('kyoutokunoran.csv', {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          const lat = parseFloat(row.緯度);
          const lng = parseFloat(row.経度);
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.circleMarker([lat, lng], {
              radius: 8,
              fillColor: "red",
              color: "black",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);
            marker.bindPopup(`<strong>${row.発生日}</strong><br/>${row.内容}`);
            const [y, m, d] = row.発生日.split('/').map(Number);
            const date = new Date(y, m - 1, d);  // 月は0始まり
            marker.hasseiDate = date;
            marker.hasseiYear = parseInt(date.getFullYear(), 10);
            markers_kyoutoku.push(marker);
          }
        });

        //初期表示
        const date = updateKyoutokuDisplay(parseInt(sliderKyoutoku.value, 10));
        updateMarkerColorsKyoutoku(date);
      }
    });
    
  </script>

</body>
</html>
